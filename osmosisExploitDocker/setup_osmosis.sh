#!/bin/bash

RAND=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 13 ; echo '')

MAINPATH=/tmp/testnet-$RAND
HOMEPATH=$MAINPATH/daemon
echo MAINPATH: $MAINPATH

mkdir $MAINPATH
mkdir $MAINPATH/cosmovisor/
mkdir $MAINPATH/cosmovisor/genesis
mkdir $MAINPATH/cosmovisor/genesis/bin
mkdir $HOMEPATH

echo $MAINPATH > /tmp/currentNode.txt

# Setup the daemon to run
ln /home/osmosisDOS/osmosis/build/osmosisd $MAINPATH/cosmovisor/genesis/bin/osmosisd -s

## Setup initial steps for chain
osmosisd keys add joe --keyring-backend test --home $HOMEPATH
echo 1
osmosisd init testnet --home $HOMEPATH --chain-id testnet 
echo 2
osmosisd add-genesis-account joe 100000000000stake --home $HOMEPATH --keyring-backend test 
echo 3
osmosisd gentx joe 1000000000stake --chain-id testnet --home $HOMEPATH --keyring-backend test
echo 4
osmosisd collect-gentxs --home $HOMEPATH

# Execute the command with cosmosvisor and pyport
export DAEMON_NAME=osmosisd
export DAEMON_HOME=$MAINPATH
export DAEMON_ALLOW_DOWNLOAD_BINARIES=true
export DAEMON_LOG_BUFFER_SIZE=512
export DAEMON_RESTART_AFTER_UPGRADE=true
export UNSAFE_SKIP_BACKUP=true

mkdir $MAINPATH/data

echo $DAEMON_NAME
cosmovisor version
cosmovisor start --home $HOMEPATH
