FROM ubuntu:22.04 as base

RUN apt-get update -y
RUN DEBIAN_FRONTEND="noninteractive" TZ="America/New_York" apt-get install gcc git python3.5 make tmux wget -y

RUN git clone https://github.com/crypto-org-chain/cronos

RUN DEBIAN_FRONTEND="noninteractive" TZ="America/New_York" apt-get install python3-pip -y
RUN DEBIAN_FRONTEND="noninteractive" TZ="America/New_York" apt-get install build-essential checkinstall curl vim libssl-dev libreadline-dev libncurses5-dev  libncurses5-dev libncursesw5-dev xz-utils tk-dev libffi-dev liblzma-dev libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev software-properties-common -y


# Go lang things
RUN wget https://golang.org/dl/go1.20.1.linux-amd64.tar.gz
RUN tar -xvf go1.20.1.linux-amd64.tar.gz
RUN mv go /usr/local
ENV GOPATH=$HOME/go
ENV PATH=$PATH:/usr/local/go/bin:$GOPATH/bin 

# *****Vulnerable version of Cosmovisor******
RUN go install github.com/cosmos/cosmos-sdk/cosmovisor/cmd/cosmovisor@v0.1.0

# PyYAML 5.4.x is broken rn - https://github.com/yaml/pyyaml/issues/724
RUN python3 -m pip install PyYAML==5.3.1
RUN python3 -m pip install pystarport # Node runner for Cronos

WORKDIR /cronos

# Build the cronos blockchain
RUN git checkout tags/v1.0.9
RUN make build 
RUN ln /cronos/build/cronosd -s /bin/cronosd

WORKDIR / 

# Node start script and exploit scripts
COPY make_setup.sh make_setup.sh
COPY start.sh start.sh
COPY exploit.sh exploit.sh 
COPY malicious_proposal.json malicious_proposal.json

# Use our own devnet file so that we know the mnenonics inside of it
COPY cronos-devnet.yaml /cronos/scripts/cronos-devnet.yaml 

# Malicious update script
COPY hacker.sh hacker.sh 

RUN chmod +x make_setup.sh
RUN chmod +x start.sh
RUN chmod +x exploit.sh

ENTRYPOINT ["/start.sh"]
